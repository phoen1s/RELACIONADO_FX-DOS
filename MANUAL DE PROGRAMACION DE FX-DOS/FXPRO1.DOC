＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝
                 ＦＸ−ＤＯＳ  Ｖｅｒｓｉｏｎ  １．７０
                     −プログラマーズマニュアル１−
                       ファンクションリクエスト篇
＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝

　これはFX-DOS用のプログラムを組む際に必要となる情報、特にファンクション
リクエストに関するものを解説しています。
　本書はMS-DOSに関する十分な知識があるということを前提とした解説をしている
ので、そうでない人は別途MS-DOSの参考資料を用意することをおすすめします。


１．システムコール
------------------------------
  　FX-DOSがコールドスタートすると、いくつかのソフトウェア割り込みが新しく
  使用可能になります。このソフトウェア割り込みのことをシステムコールと呼び、
  アプリケーションがFX-DOSの機能を使用するときは大概このシステムコールを
  用いることになります。

        INT 21H ･･･ ファンクションリクエスト
        INT 23H ･･･ [BRK]抜け出しアドレス
        INT 25H ･･･ アブソリュート・ディスクリード
        INT 26H ･･･ アブソリュート・ディスクライト
        INT 29H ･･･ ダイレクト・コンソール出力
        INT 2BH ･･･ FEP入力
        INT 2CH ･･･ ダイレクト・ファイル・アクセス
        INT 30H ･･･ FEPステータス情報

  ◎ファンクションリクエスト (INT 21H)
      入力：AH=ファンクション番号
            その他は呼び出すファンクションによる。
      出力：呼び出すファンクションによる。
      破壊：AX
    　解説：ファイル操作やデータ入出力といった、FX-DOSが提供するほとんどの
            機能はこれにより提供されます。

  ◎[BRK]抜け出しアドレス (INT 23H)
      入力：なし
      出力：なし
      解説：[BRK]を押したときに実行されるルーチンのアドレスを指定する。
            標準では全てのファイルをクローズしてコマンドラインに移行するよう
            になっているが、ユーザーが処理ルーチンを用意してもいい。
            ユーザーが処理するときは、ルーチン内でSPをリセットする必要がある。

  ◎アブソリュート・ディスクリード／ライト (INT 25H/26H)
      入力：AL=ドライブ番号 (E0=10,E1=11,･･･,E5=15)
            DS:BX=データ転送アドレス
            CX=セクタ数
            DX=開始セクタ番号
      出力：Cy.AL=エラー
      破壊：AX,BX,CX,DX,BP,DI,SI
      解説：拡張ドライブとセクタ単位でデータをやり取りする。
            この機能は拡張ドライブに対してのみ使用可で、なお且つデバドラが
            サポートしていないと使用出来ません。
            なお、割り込み時のフラグがスタックに積まれたまま戻ってくるので
            「POP F」でスタックの段を戻す必要があるのでご注意を。

  ◎ダイレクト・コンソール出力 (INT 29H)
      入力：AL=出力文字
      出力：なし
      破壊：なし
      解説：文字表示ルーチンに直接データを送る。
            直接文字表示デバドラに接続されるので、高速に文字表示をすることが
            出来ます。

  ◎ＦＥＰ入力 (INT 2BH)
      入力：なし
      出力：AL=入力文字
            AH=バッファに溜まっている文字数
      破壊：AX
      解説：キー入力デバドラからデータを読む。(FEPが無くても使えます)
            入力データが無いときは入力されるまで待つ。

  ◎ダイレクト・ファイル・アクセス (INT 2CH)
      入力：DS:DX=ＦＣＢ型式のファイル名
      出力：DXAX =ファイルサイズ
            DS:SI=ファイル先頭アドレス
            Cy.AX=エラー (2,5,15)
      破壊：AX,BX,CX,DX,BP,DI,SI,DS,ES
      解説：基本ドライブ上にあるファイルのデータ部先頭アドレスを求める。
            ファイル内容はDS:SIを先頭に連続したメモリ空間に存在しています。
            これは、高速にファイルをアクセスしたいときに使用するのですが、
            不用意に使うと他のファイルを破壊しかねないので、使用の際は十分に
            注意して下さい。
            ※先頭アドレスを求めたのちファンクション等でファイルをアクセス
              した場合、これらの情報の信憑性は無くなります。

  ◎FEPステータス情報 (INT 30H)
      入力：AH=0 バージョンの習得 (AX)
               1 入力モードの習得 (AL)
               2 入力モードの設定 (AL=0:ANK , FF:漢字)
      出力：AX=バージョン                             ;入力がAH=0の時
            AL=入力モード (0:ANK , FF:漢字)           ;入力がAH=1の時
      破壊：AX
      解説：FEPの状態を調べたり設定したりする。
            これはFEPがないと使用出来ませんが、それを逆に利用してFEPが登録
            されているかを調べる事にも使えます。AXに0を入れてINT 30Hを実行
            したとき、もしAXが0のままならFEPは登録されていません。


２．ファンクションリクエスト
------------------------------
  　FX-DOSが提供する大部分のサービスは、このファンクションリクエストによって
  使用可能です。
  　基本的にはMS-DOSのファンクションを参考にしていますが、中には多少動作が
  違うものやFX-DOS独自のものなどが含まれます。
  トラブルの際に返されるエラーコードが、MS-DOSの場合と違っている可能性がある
  ので注意してください。

  ※ファンクションでは基本的にAXは破壊されます。
  ※「*」が付いているものは動作がMS-DOSと違う部分があります。

      00H ･･･ プロセスの終了             3AH ････ ｻﾌﾞﾃﾞｨﾚｸﾄﾘの削除
      01H ･･･ キー入力(エコーあり)       3BH ････ ｶﾚﾝﾄﾃﾞｨﾚｸﾄﾘの変更 
      02H ･･･ スクリーン出力             3CH ････ ファイル作成
      03H ･･･ AUX出力                   *3DH ････ ファイルのオープン
      04H ･･･ AUX入力                    3EH ････ ファイルのクローズ
      05H ･･･ PRN出力                    3FH ････ ファイル読み込み
      06H ･･･ 直接コンソールI/O          40H ････ ファイル書き込み
      07H ･･･ 直接コンソール入力         41H ････ ファイル削除
      08H ･･･ キー入力                   42H ････ ファイルポインタ移動
      09H ･･･ 文字列出力                *43H ････ ファイル属性取得／設定
      0AH ･･･ 文字列入力                *4400H ･･ デバイス情報の取得
      0BH ･･･ キーボードの検査           4406H ･･ 入力ステータス取得
      0CH ･･･ ﾊﾞｯﾌｧを空にしてキー入力    4407H ･･ 出力ステータス取得
      0EH ･･･ カレントドライブ設定      *440EH ･･ ドライブマップ取得
      19H ･･･ カレントドライブ取得       47H ････ カレントディレクトリの取得
      1AH ･･･ DTAアドレス設定            48H ････ メモリブロックの割当て
     *25H ･･･ 割り込みベクタ設定         4AH ････ メモリブロックサイズの変更
      2AH ･･･ 日付の取得                 4BH ････ プログラムの実行
      2BH ･･･ 日付の設定                *4CH ････ プロセスの終了
      2CH ･･･ 時刻の取得                 4DH ････ 終了コードの取得
      2DH ･･･ 時刻の設定                 4EH ････ ファイルサーチ
      2FH ･･･ DTAアドレス取得            4FH ････ 続けてファイルサーチ
     *30H ･･･ バージョン番号の取得       52H ････ 環境変数アドレスの取得
     *31H ･･･ プロセスの常駐終了         56H ････ ファイル名の変更
     *35H ･･･ 割り込みベクタの取得       57H ････ ファイルの日時の取得／設定
      36H ･･･ ディスクの空きｽﾍﾟｰｽを取得  5BH ････ ファイルの新規作成
      39H ･･･ ｻﾌﾞﾃﾞｨﾚｸﾄﾘの作成 

     *80H ･･･ ディスクのフォーマット    *88H ･･･ 曜日の習得
     *81H ･･･ メッセージ文字列を得る    *89H ･･･ 環境変数の登録
     *82H ･･･ キークリックの音量設定    *8AH ･･･ 環境変数の取得
     *83H ･･･ キークリックの音量の取得  *8BH ･･･ FFEの割り当て
     *84H ･･･ ﾏｼﾝ語ｴﾘｱの大きさを得る    *8CH ･･･ CONのﾋｽﾄﾘｰﾊﾞｯﾌｧの指定
     *85H ･･･ ファイル名を標準型式に    *8DH ･･･ AUXのオープン
     *86H ･･･ ファイル名をFCB型式に     *8EH ･･･ AUXのクローズ
     *87H ･･･ バッチファイルの起動      *8FH ･･･ ﾃﾞｨﾚｸﾄﾘﾊﾟｽの解析

  ◎割り込みベクタ設定 (AH=25H)
      入力：AL=割り込み番号
            DS:DX=ベクタ
      出力：なし
      解説：ベクタアドレスがファイルエリア「F0」の先頭アドレスより大きく、
            なおかつRAM最後尾より小さい場合、セルフリロケーション処理を経由
            する。

  ◎バージョン番号の取得 (AH=30H)
      入力：なし
      出力：AX=0A03H
            BX=0FF00H
            CL=バージョン番号整数部
            CH=バージョン番号小数部
      解説：バージョンが1.23の場合は、「CL=1,CH=23」が返される。
            MS-DOSの場合だとCXにはユーザー番号として「0」が返されるので、
            これをチェックすることでOSがFX-DOSなのかMS-DOSなのかを調べること
            が出来ます。

  ◎プロセスの常駐終了 (AH=31H)
      入力：AL=終了コード
      出力：なし
      解説：これはMS-DOSとの互換性のために用意してあるもので、内部動作は
            「プロセスの終了 (AH=4CH)」と全く同じです。

  ◎割り込みベクタの取得 (AH=35H)
      入力：AL=割り込み番号
      出力：AL=リンクフラグ（0FFH:DOSリンク）
            ES:BX=ベクタ
      解説：DOSリンクとは、割り込み処理ルーチンがDOSシステム内にあることを
            示しています。

  ◎ファイルのオープン (AH=3DH)
      入力：AL=アクセス方法
            DS:DX=パス名
      出力：AX=ファイルハンドル
      解説：アクセス方法の指定で、b2が１の時はオープンロックと言うことで
            以後クローズすることが出来なくなる。

  ◎ファイル属性取得／設定 (AH=43H)
      入力：AL=0:取得／1:設定
            CX=属性
            DS:DX=パス名
      出力：CX=属性
      解説：各ビットと属性との関係は以下の通り。
                b0 ･････ リードオンリー
                b1 ･････ 不可視
                b2 ･････ システムファイル
                b3 ･････ 予約
                b4 ･････ サブディレクトリ
                b5 ･････ 未バックアップ
                b6 ･････ ファイル種別（0:テキスト、1:バイナリ）
                b7 ･････ 予約

  ◎デバイス情報の取得 (AX=4400H)
      入力：AL=0
            BX=ファイルハンドル
      出力：DX=デバイス情報
      解説：返されるデバイス情報のうち、ISDEV（デバイス種別）がb8になっている
            ことに注意してください。

  ◎ドライブマップ取得 (AX=440EH)
      入力：AL=0EH
      出力：AX=ドライブマップ
      解説：各ビットとドライブの関係は、
                b15 b14 b13 b12 b11 b10 b9 b8 b7 b6 b5 b4 b3 b2 b1 b0
                E5  E4  E3  E2  E1  E0  F9 F8 F7 F6 F5 F4 F3 F2 F1 --
            となっており、ドライブとして使えるものは対応するビットが１に
            なります。
            なお、このファンクションの動作はMS-DOSとは異なっています。

  ◎プロセスの終了 (AH=4CH)
      入力：AL=リターンコード
      出力：なし
      解説：DOSのコマンドラインに移行します。


  ◎ディスクのフォーマット (AH=80H)
      入力：DL=ドライブ番号
      出力：なし
      解説：デバドラに対してフォーマットの指示を出します。
            ドライブ名とドライブ番号の対応は以下の通り。
                F1〜F9 E0〜E5
                1 〜9  10〜15

  ◎メッセージ文字列を得る (AH=81H)
      入力：AL=メッセージコード
            DS:DX=バッファ (64バイト)
      出力：CX=メッセージ文字数
            バッファ=メッセージ文字列
      解説：メッセージ文字列の最後にはCR,LFが付いています。
            コードと文字列の対応は後述。

  ◎キークリックの音量設定 (AH=82H)
      入力：DL=音量 (0〜255)
      出力：なし
      解説：音量0で消音。

  ◎キークリックの音量の取得 (AH=83H)
      入力：なし
      出力：AL=音量
      解説：なし

  ◎ﾏｼﾝ語ｴﾘｱの大きさを得る (AH=84H)
      入力：なし
      出力：AX=マシン語エリアサイズ
      解説：サイズはバイト単位。

  ◎ファイル名を標準型式に (AH=85H)
      入力：DS:DX=パス名
            ES:BX=バッファ (16バイト)
      出力：バッファ=標準型式のファイル名 (ASCIIZ文字列)
      解説：標準型式のファイル名とは、ドライブ名＋ファイル名（8文字）
            ＋‘.’＋拡張子（3文字）を指します。
            「F1:CONFIG  .SYS\0」

  ◎ファイル名をFCB型式に (AH=86H)
      入力：DS:DX=パス名
            ES:BX=バッファ (12バイト)
      出力：バッファ=FCB型式のファイル名
      解説：FCB型式のファイル名とは、ドライブ番号＋ファイル名 (8文字)
            ＋拡張子 (3文字) を指します。
            「\1CONFIG  SYS」

  ◎バッチファイルの起動 (AH=87H)
      入力：DS:DX=パス名
            ES:BX=パラメータ文字列 (ASCIIZ文字列)
      出力：なし
      解説：バッチファイルの実行が終了したら、処理はコマンドラインに移行
            します。

  ◎曜日の習得 (AH=88H)
      入力：CX=年（1980〜2079）
            DH=月（1〜12）
            DL=日（1〜31）
      出力：AL=曜日（0:日,1:月,2:火,3:水,4:木,5:金,6:土）
      解説：ピタゴラス暦に基づいて算出しています。

  ◎環境変数の登録 (AH=89H)
      入力：DS:DX=変数名
            ES:BX=内容
      出力：なし
      解説：変数名や内容の最後にはかならず00Hを付加してください。
            内容が00Hだけの場合は変数を削除します。
            同名の変数があるときは、元からあった変数を削除した後登録を行い
            ます。

  ◎環境変数の取得 (AH=8AH)
      入力：DS:DX=変数名
            ES:BX=バッファ
      出力：AX=文字数
            バッファ=内容
      解説：変数名の最後にはかならず00Hを付加してください。
            環境変数の内容の大きさには制限が無いので、バッファは出来る限り
            大きく確保してください。

  ◎FFEの割り当て (AH=8BH)
      入力：BX=大きさ (パラグラフ単位)
      出力：AX=スタートセグメント
      解説：ファイルフリーエリアからワークエリアを取得する。
            一度割り当てられた領域は電源を切るまで開放されません。
            これは主にデバドラの常駐領域の取得に使われています。

  ◎CONヒストリーバッファの指定 (AH=8CH)
      入力：DS:DX=ヒストリーバッファ (258バイト)
      出力：なし
      解説：「CON」デバイスのヒストリー用バッファを指定する。
            これはバッファードキー入力 (AH=0AH) を行うときのヒストリーを変更
            したいときに使います。
            DXにFFFFHを指定すると、デフォルト(DOSコマンドライン)になります。
            ヒストリーバッファの書式は、

                    読み出し位置(1),書き込み位置(1),バッファ(256)

            バッファはリングバッファで、一行の区切りは「[CR]\0」です。

  ◎AUXのオープン (AH=8DH)
      入力：なし
      出力：なし
      解説：AUXデバイスを直接オープンさせます。
            シリアルから受信したデータはシステムエリアの「RXCNT(BIOSのB9HでDI
            に返される)」へ書き込まれるので、そこから取得出来ます。

  ◎AUXのクローズ (AH=8EH)
      入力：なし
      出力：なし
      解説：上の「AUXのオープン」でオープンさせたAUXデバイスをクローズさせま
            す。
            AUXを重複してオープンさせていた場合は、オープンした数だけクローズ
            を行わないときちんとクローズされません。 (余計にクローズする分には
            問題ありません)

  ◎ディレクトリバスの解析 (AH=8FH)
      入力：DS:DX=ファイル名文字列
            ES:BX=バッファ (64バイト)
      出力：バッファ=ディレクトリパス
      解説：ファイル名文字列からディレクトリに相当する部分を抜き出します。
            ディレクトリが省略されていても、現在のカレントディレクトリの設定
            からディレクトリパスを割り出します。
            「F1:\\0」
            「E1:\DATA\ETC\\0」


３．メッセージ文字列
------------------------------
  　ファンクションリクエストの81Hで取得できるメッセージとメッセージコードの
  対応は以下のようになっています。

         0:???
         1:Cannot format this drive
         2:Unrecognized command
         3:Command too long
         4:File cannot be copied onto itself
         5:Disk full
         6:Too many parameters
         7:Missing parameter
         8:File not found
         9:Read only file
        10:Cannot overwrite previous destination file
        11:Duplicate filename
        12:Invalid filename
        13:Invalid option
        14:Invalid environment string
        15:Invalid time
        16:Invalid number
        17:Invalid drive
        18:Invalid parameter
        19:Invalid date
        20:Not enough memory
        21:No spare file handles
        22:Cannot access
        23:Out of system free
        24:Bath file error
        25:Strike a key when ready
        26:Invaild 'EXE' format
        27:Buffer overflow
        28:Framing error
        29:Overrun error
        30:Parity error
        31:Disk write-protected
        32:Disk is not ready
        33:Path not found


４．プログラム作成時の注意点
------------------------------
  ◎メモリ割り当て
    　ファンクションの48H (メモリの割り当て) によって割り当てられるメモリは
    DOSシステムの最後尾、ファイルエリア「F0」と「F1」の間に必要な分だけ確保
    されユーザーに開放されますが、これはあくまでも一時的に割り当てられたもの
    で、コマンドラインに移行した次点で全て削除されます。
    ですから、MS-DOSのように常駐プログラムをこれで登録することはできません。
    　常駐プログラムを登録するときはファンクション8BH (FFEの割り当て) を使用
    してください。
    FFE (ファイルフリーエリア) とはファイルエリア「F9」の後ろからRAM最後尾ま
    での間の領域の事で、割り当てはこの領域の後ろから必要量が切り出され、提供
    されます。

  ◎ファイルアクセス
    　基本ドライブをアクセスする場合、ファイルへの書き込みでファイルサイズが
    拡大する時にかなり時間がかかるので、予めファイルを目的のサイズまで拡大
    しておいてからデータを書き込んでいくと言う方法を使うと、意外に処理が速く
    なったりします。

  ◎ファイルハンドルの最大
    　同時にオープン出来るファイルの最大数は20個 (デバイスを含む) です。

  ◎BIOSの使用
    　FX-DOS用のプログラムでもBIOSの使用は許可していますが、文字の表示を行う
    際はBIOSを使用しないで下さい。
    これは今後文字表示デバドラが出てきた時に、そのサービスが受けられなくなる
    からです。
    　また、BIOS使用時はセグメントに注意して下さい。
    中にはDS=0でないと正常に動かないものもありますから。

  ◎キー入力
    　キー入力を行う方法にはBIOSを使用する、INT 2BHを使用するの二つの方法が
    ありますが、これは場合によって使い分けるのがいいでしょう。
    例えばカーソルを動かしたりする時にINT 2BHを使用すると、不必要な時にFEPが
    起動してしまったりしますから。
    　BIOSの03Hや04Hを使用するとそのままではキーリピートが効きませんが、これら
    を実行した直後にBIOSの47Hを実行することで、キーリピートを行わせることが
    出来るようになります。

  ◎スタックポインタ
    　基本的にスタックポインタの値は変更しないでください。
    アプリケーション実行時のスタックはシステムスタックに設定されています (これ
    はEXE型式、COM/CMD型式、BIN型式すべてに共通) が、これを別のセグメントに
    移動させたりするとキー入力が効かなくなります。
    これはBIOSの制約によるものなので、修正するのは無理なんです。
    　アプリケーションの終了 (ファンクション4CH) を実行するとき、スタックの
    段数を戻す必要はありません。

  ◎ニーモニックの'ESC'命令に対する対策
    　FX-890PのCPUに使われている80188EBでニーモニックの'ESC'命令を実行すると
    ハングアップしてしまいますが、FX-DOSはこれに対する対策をとっているので
    実行してもハングアップしないようになっています。
    　これはFX-DOS上でMS-DOS用のソフトを実行出来るようにするためのものでして、
    MS-DOS用のソフトの中にはこの'ESC'命令を使用しているものが少なからずある
    ため、それらのソフトを動かすための対策です。

  ◎MS-DOS用のソフトについて
    　FX-DOSが扱うファイル型式で、COM型式とEXE型式についてはMS-DOSの場合と全
    く同等に処理が行われます。
    ですから例えばC言語等の高級言語を使ってFX-DOS用のソフトを組むことも可能
    です。


                                製作／著者

                         ポケット通信  ＃３７０８
                         NIFTY-Serve   YHW02344
                                ＳＴＥＡＲ
